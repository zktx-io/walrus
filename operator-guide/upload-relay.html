<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Upload relay: functioning and operation - Walrus</title>


        <!-- Custom HTML head -->
        <script type="text/javascript">
          // Hacky check to only load Amplitude in production since we don't have environments:
          const localAddresses = ['localhost', '127.0.0.1', '[::1]'];
          if (localAddresses.indexOf(document.location.hostname) === -1) {
            !function(){"use strict";!function(e,t){var r=e.amplitude||{_q:[],_iq:{}};if(r.invoked)e.console&&console.error&&console.error("Amplitude snippet has been loaded.");else{var n=function(e,t){e.prototype[t]=function(){return this._q.push({name:t,args:Array.prototype.slice.call(arguments,0)}),this}},s=function(e,t,r){return function(n){e._q.push({name:t,args:Array.prototype.slice.call(r,0),resolve:n})}},o=function(e,t,r){e._q.push({name:t,args:Array.prototype.slice.call(r,0)})},i=function(e,t,r){e[t]=function(){if(r)return{promise:new Promise(s(e,t,Array.prototype.slice.call(arguments)))};o(e,t,Array.prototype.slice.call(arguments))}},a=function(e){for(var t=0;t<g.length;t++)i(e,g[t],!1);for(var r=0;r<m.length;r++)i(e,m[r],!0)};r.invoked=!0;var c=t.createElement("script");c.type="text/javascript",c.integrity="sha384-pY2pkwHaLM/6UIseFHVU3hOKr6oAvhLcdYkoRZyaMDWLjpM6B7nTxtOdE823WAOQ",c.crossOrigin="anonymous",c.async=!0,c.src="https://cdn.amplitude.com/libs/analytics-browser-2.11.0-min.js.gz",c.onload=function(){e.amplitude.runQueuedFunctions||console.log("[Amplitude] Error: could not load SDK")};var u=t.getElementsByTagName("script")[0];u.parentNode.insertBefore(c,u);for(var p=function(){return this._q=[],this},l=["add","append","clearAll","prepend","set","setOnce","unset","preInsert","postInsert","remove","getUserProperties"],d=0;d<l.length;d++)n(p,l[d]);r.Identify=p;for(var f=function(){return this._q=[],this},v=["getEventProperties","setProductId","setQuantity","setPrice","setRevenue","setRevenueType","setEventProperties"],y=0;y<v.length;y++)n(f,v[y]);r.Revenue=f;var g=["getDeviceId","setDeviceId","getSessionId","setSessionId","getUserId","setUserId","setOptOut","setTransport","reset","extendSession"],m=["init","add","remove","track","logEvent","identify","groupIdentify","setGroup","revenue","flush"];a(r),r.createInstance=function(e){return r._iq[e]={_q:[]},a(r._iq[e]),r._iq[e]},e.amplitude=r}}(window,document)}();
            amplitude.init('f60df2d0d709d50faa2ffda153a84bc0', { identityStorage:'none', defaultTracking: true });
          }
        </script>
        
        <script>
            function initAskCookbook() {
              // It's a public API key, so it's safe to expose it here
              const PUBLIC_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2NzU4Y2YyODM4NTcxODU5MjU0MGIyMDciLCJpYXQiOjE3MzM4NzM0NDgsImV4cCI6MjA0OTQ0OTQ0OH0.Z3cv3HuMkYq3aYZYzCKkkYuM5LI3KG-kuA0R-GaSMV4";
        
              let cookbookContainer = document.getElementById("__cookbook");
              if (!cookbookContainer) {
                cookbookContainer = document.createElement("div");
                cookbookContainer.id = "__cookbook";
                cookbookContainer.dataset.apiKey = PUBLIC_API_KEY;
                document.body.appendChild(cookbookContainer);
              }
        
              let cookbookScript = document.getElementById("__cookbook-script");
              if (!cookbookScript) {
                cookbookScript = document.createElement("script");
                cookbookScript.id = "__cookbook-script";
                cookbookScript.src = "https://cdn.jsdelivr.net/npm/@cookbookdev/docsbot/dist/standalone/index.cjs.js";
                cookbookScript.async = true;
                document.head.appendChild(cookbookScript);
              }
        
        
              const keyPressPropagationBlocker = function (e) {
                e.stopPropagation();
              };
              document.addEventListener("cookbook:modal:state:change", function (e) {
                const isOpen = e.detail.isOpen;
                if (isOpen) {
                  document.body.addEventListener("keydown", keyPressPropagationBlocker, { capture: true });
                } else {
                  document.body.removeEventListener("keydown", keyPressPropagationBlocker, { capture: true });
                }
              });
            }
        
            // Check if the document is already loaded and if so, initialize the script, otherwise wait for the load event
            if (document.readyState === "complete") {
              initAskCookbook();
            } else {
              window.addEventListener("load", initAskCookbook);
            }
          </script>
        
          <meta name="algolia-site-verification" content="BCA21DA2879818D2">

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../docs/mdbook-admonish.css">
        <link rel="stylesheet" href="../docs/theme/tabs.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Walrus</a></li><li class="chapter-item expanded affix "><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Dev Blog</li><li class="chapter-item expanded "><a href="../blog/00_intro.html"><strong aria-hidden="true">1.</strong> Blog Preface</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../blog/01_announcing_walrus.html"><strong aria-hidden="true">1.1.</strong> Announcing Walrus</a></li><li class="chapter-item expanded "><a href="../blog/02_devnet_update.html"><strong aria-hidden="true">1.2.</strong> Devnet Update</a></li><li class="chapter-item expanded "><a href="../blog/03_whitepaper.html"><strong aria-hidden="true">1.3.</strong> Announcing the Walrus Whitepaper</a></li><li class="chapter-item expanded "><a href="../blog/04_testnet_update.html"><strong aria-hidden="true">1.4.</strong> Announcing Testnet</a></li><li class="chapter-item expanded "><a href="../blog/05_testnet_redeployment.html"><strong aria-hidden="true">1.5.</strong> Announcing Testnet v2</a></li><li class="chapter-item expanded "><a href="../blog/06_mainnet.html"><strong aria-hidden="true">1.6.</strong> Announcing Mainnet</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Usage</li><li class="chapter-item expanded "><a href="../usage/started.html"><strong aria-hidden="true">2.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="../usage/setup.html"><strong aria-hidden="true">3.</strong> Setup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../usage/networks.html"><strong aria-hidden="true">3.1.</strong> Available networks</a></li></ol></li><li class="chapter-item expanded "><a href="../usage/interacting.html"><strong aria-hidden="true">4.</strong> Interacting with Walrus</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../usage/client-cli.html"><strong aria-hidden="true">4.1.</strong> Using the client CLI</a></li><li class="chapter-item expanded "><a href="../usage/json-api.html"><strong aria-hidden="true">4.2.</strong> Using the client JSON API</a></li><li class="chapter-item expanded "><a href="../usage/web-api.html"><strong aria-hidden="true">4.3.</strong> Using the client HTTP API</a></li><li class="chapter-item expanded "><a href="../usage/sdks.html"><strong aria-hidden="true">4.4.</strong> SDKs and other tools</a></li></ol></li><li class="chapter-item expanded "><a href="../dev-guide/dev-guide.html"><strong aria-hidden="true">5.</strong> Developer guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dev-guide/components.html"><strong aria-hidden="true">5.1.</strong> Components</a></li><li class="chapter-item expanded "><a href="../dev-guide/dev-operations.html"><strong aria-hidden="true">5.2.</strong> Operations</a></li><li class="chapter-item expanded "><a href="../dev-guide/costs.html"><strong aria-hidden="true">5.3.</strong> Storage costs</a></li><li class="chapter-item expanded "><a href="../dev-guide/sui-struct.html"><strong aria-hidden="true">5.4.</strong> Sui structures</a></li><li class="chapter-item expanded "><a href="../dev-guide/data-security.html"><strong aria-hidden="true">5.5.</strong> Data security</a></li><li class="chapter-item expanded "><a href="../usage/quilt.html"><strong aria-hidden="true">5.6.</strong> Quilt</a></li></ol></li><li class="chapter-item expanded "><a href="../operator-guide/operator-guide.html"><strong aria-hidden="true">6.</strong> Operator guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../operator-guide/aggregator.html"><strong aria-hidden="true">6.1.</strong> Operating an aggregator or publisher</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../operator-guide/auth-publisher.html"><strong aria-hidden="true">6.1.1.</strong> The authenticated publisher</a></li></ol></li><li class="chapter-item expanded "><a href="../operator-guide/storage-node.html"><strong aria-hidden="true">6.2.</strong> Operating a storage node</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../operator-guide/commission-governance.html"><strong aria-hidden="true">6.2.1.</strong> Commission and governance</a></li><li class="chapter-item expanded "><a href="../operator-guide/backup-restore-guide.html"><strong aria-hidden="true">6.2.2.</strong> Backup and restore</a></li></ol></li><li class="chapter-item expanded "><a href="../operator-guide/upload-relay.html" class="active"><strong aria-hidden="true">6.3.</strong> Upload relay: functioning and operation</a></li></ol></li><li class="chapter-item expanded "><a href="../usage/stake.html"><strong aria-hidden="true">7.</strong> Staking and unstaking</a></li><li class="chapter-item expanded "><a href="../usage/examples.html"><strong aria-hidden="true">8.</strong> Examples</a></li><li class="chapter-item expanded "><a href="../usage/troubleshooting.html"><strong aria-hidden="true">9.</strong> Troubleshooting</a></li><li class="chapter-item expanded affix "><li class="part-title">Sites</li><li class="chapter-item expanded "><a href="../walrus-sites/intro.html"><strong aria-hidden="true">10.</strong> Introduction to Walrus Sites</a></li><li class="chapter-item expanded "><a href="../walrus-sites/tutorial.html"><strong aria-hidden="true">11.</strong> Your first Walrus Site</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../walrus-sites/tutorial-install.html"><strong aria-hidden="true">11.1.</strong> Installing the site builder</a></li><li class="chapter-item expanded "><a href="../walrus-sites/tutorial-publish.html"><strong aria-hidden="true">11.2.</strong> Publishing a Walrus Site</a></li><li class="chapter-item expanded "><a href="../walrus-sites/tutorial-suins.html"><strong aria-hidden="true">11.3.</strong> Set a SuiNS name</a></li></ol></li><li class="chapter-item expanded "><a href="../walrus-sites/advanced.html"><strong aria-hidden="true">12.</strong> Advanced functionality</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../walrus-sites/commands.html"><strong aria-hidden="true">12.1.</strong> Site builder commands</a></li><li class="chapter-item expanded "><a href="../walrus-sites/builder-config.html"><strong aria-hidden="true">12.2.</strong> Advanced site-builder configuration</a></li><li class="chapter-item expanded "><a href="../walrus-sites/routing.html"><strong aria-hidden="true">12.3.</strong> Specifying headers, routing, and metadata</a></li><li class="chapter-item expanded "><a href="../walrus-sites/linking.html"><strong aria-hidden="true">12.4.</strong> Linking from and to Walrus Sites</a></li><li class="chapter-item expanded "><a href="../walrus-sites/redirects.html"><strong aria-hidden="true">12.5.</strong> Redirecting objects to Walrus Sites</a></li><li class="chapter-item expanded "><a href="../walrus-sites/ci-cd.html"><strong aria-hidden="true">12.6.</strong> CI/CD</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../walrus-sites/ci-cd-gh-secrets-vars.html"><strong aria-hidden="true">12.6.1.</strong> Setting up GitHub secrets and vars</a></li><li class="chapter-item expanded "><a href="../walrus-sites/ci-cd-gh-workflow.html"><strong aria-hidden="true">12.6.2.</strong> Creating GitHub workflow</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../walrus-sites/overview.html"><strong aria-hidden="true">13.</strong> Technical overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../walrus-sites/portal.html"><strong aria-hidden="true">13.1.</strong> The Walrus Sites portal</a></li><li class="chapter-item expanded "><a href="../walrus-sites/bring-your-own-domain.html"><strong aria-hidden="true">13.2.</strong> Bring your own domain</a></li><li class="chapter-item expanded "><a href="../walrus-sites/authentication.html"><strong aria-hidden="true">13.3.</strong> Site data authentication</a></li><li class="chapter-item expanded "><a href="../walrus-sites/restrictions.html"><strong aria-hidden="true">13.4.</strong> Known restrictions</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Design</li><li class="chapter-item expanded "><a href="../design/objectives_use_cases.html"><strong aria-hidden="true">14.</strong> Objectives and use cases</a></li><li class="chapter-item expanded "><a href="../design/overview.html"><strong aria-hidden="true">15.</strong> Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../design/architecture.html"><strong aria-hidden="true">15.1.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../design/encoding.html"><strong aria-hidden="true">15.2.</strong> Encoding</a></li></ol></li><li class="chapter-item expanded "><a href="../design/operations.html"><strong aria-hidden="true">16.</strong> Operations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../design/operations-sui.html"><strong aria-hidden="true">16.1.</strong> Sui operations</a></li><li class="chapter-item expanded "><a href="../design/operations-off-chain.html"><strong aria-hidden="true">16.2.</strong> Off-chain operations</a></li></ol></li><li class="chapter-item expanded "><a href="../design/properties.html"><strong aria-hidden="true">17.</strong> Properties</a></li><li class="chapter-item expanded "><a href="../design/future.html"><strong aria-hidden="true">18.</strong> Future discussion</a></li><li class="chapter-item expanded affix "><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../glossary.html">Glossary</a></li><li class="chapter-item expanded affix "><a href="../legal/testnet_tos.html">Testnet terms of service</a></li><li class="chapter-item expanded affix "><a href="../legal/privacy.html">Privacy policy</a></li><li class="chapter-item expanded affix "><a href="../legal/walrus_general_tos.html">Walrus general terms of service</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Walrus</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="the-walrus-upload-relay"><a class="header" href="#the-walrus-upload-relay">The Walrus upload relay</a></h1>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>A goal of Walrus is to enable dApps to <code>store</code> to Walrus from within their end-users’ browsers
having low to moderate machine specifications (mobile devices, low-powered laptops, etc.). This
browser-based scenario is difficult to achieve in practice with an in-browser process that directly
communicates with the storage nodes due to the high number of network connections required to upload
all slivers to all shards.</p>
<p>The upload relay is a downloadable program that community members, Mysten Labs, and/or dApp writers
themselves can run on internet-facing hosts to facilitate storing blob slivers onto the storage
nodes on behalf of the end-users, thus mitigating browser resource consumption and enabling
web-based <code>store</code> operations.</p>
<div id="admonition-public-upload-relays" class="admonition admonish-tip" role="note" aria-labelledby="admonition-public-upload-relays-title">
<div class="admonition-title">
<div id="admonition-public-upload-relays-title">
<p>Public upload relays</p>
</div>
<a class="admonition-anchor-link" href="#admonition-public-upload-relays"></a>
</div>
<div>
<p>Mysten Labs runs two publicly-available upload relays, one for <code>testnet</code> and one for <code>mainnet</code>.
You can find them at the following addresses:</p>
<ul>
<li><code>testnet</code>: <code>https://upload-relay.testnet.walrus.space</code></li>
<li><code>mainnet</code>: <code>https://upload-relay.mainnet.walrus.space</code></li>
</ul>
</div>
</div>
<h2 id="design"><a class="header" href="#design">Design</a></h2>
<h3 id="outline"><a class="header" href="#outline">Outline</a></h3>
<p>At a high level, a client stores a blob using an upload relay as follows:</p>
<ol>
<li>First, the client locally encodes the blob and registers it on Sui;</li>
<li>then, the client sends the blob to the upload relay via an HTTP POST request to the blob-relay
endpoint (<code>/v1/blob-upload-relay</code>);</li>
<li>the upload relay then encodes the blob, sends the slivers to the storage nodes, collects a storage
confirmation certificate, and sends it back to the client;</li>
<li>finally, the client uses the confirmation certificate to certify the blob on Sui.</li>
</ol>
<p>Therefore, the upload relay <em>does not</em> perform any on-chain operation, and only helps clients
distribute the slivers of their blobs to storage nodes.</p>
<p>This flow between clients and the upload relay is already implemented in the Walrus CLI, Rust SDK,
and TS SDK, and therefore developers do not need to implement it themselves. For completeness, in
the following we discuss how the service is implemented, paid for, and used by clients.</p>
<h3 id="upload-relay-operation"><a class="header" href="#upload-relay-operation">Upload relay operation</a></h3>
<p>The upload relay can be operated in two ways:</p>
<ul>
<li><strong>Free service</strong>: It accepts simple HTTP POST requests with blobs from clients, and relays them to
the storage nodes for free.</li>
<li><strong>Paid service</strong> (for public relays): In this configuration, the upload relay requires a <em>tip</em> to
relay a blob. The tip can be used by the relay operator to cover the costs of running the
infrastructure and turn a profit on the service. At the moment, we allow a constant tip, and a tip
that is linear in the unencoded data size.</li>
</ul>
<p>Upload relays expose a tip-configuration endpoint (<code>/v1/tip-config</code>) that returns the tipping
configuration. For example:</p>
<pre><code class="language-json">{
  "send_tip": {
    "address": "0x1234...",
    "kind": {
      "const": 105
    }
  }
}
</code></pre>
<p>The configuration above specifies that every store operation requires a tip of <code>105 MIST</code> (arbitrary
value), paid to the set address (<code>0x1234..</code>). Note that this configuration is provided even for free
upload relays (returning <code>"no_tip"</code>).</p>
<h3 id="paying-the-tip"><a class="header" href="#paying-the-tip">Paying the tip</a></h3>
<p>This step is only necessary if the relay requires a tip.</p>
<p>To pay the tip, the client proceeds as follows:</p>
<ol>
<li>it computes the <code>blob_digest = SHA256(blob)</code></li>
<li>it generates a random <code>nonce</code>, and hashes it <code>nonce_digest = SHA256(nonce)</code></li>
<li>it computes the <code>unencoded_length = blob.len()</code></li>
</ol>
<p>Then, it creates a PTB, where the first input (<code>input 0</code>) is the <code>bcs</code> encoded representation of
<code>blob_digest || nonce_digest || unencoded_length</code>. This will later be used by the relay to
authenticate the sender of the store request. In the same PTB, the client transfers the appropriate
tip amount to the relay’s wallet (also found through the <code>/v1/tip-config</code> endpoint). Usually, the
client would also register the blob in this transaction. This is not mandatory, and the blob can be
registered in another transaction, but it is commonly convenient and cheaper to perform all these
operations together.</p>
<p>Once the transaction is executed, the client keeps the transaction ID <code>tx_id</code> , the <code>nonce</code>, and the
<code>blob_id</code>, which are required for the next phase.</p>
<p>Note: the relay will enforce a freshness check on the transaction that paid the tip (currently 1h by
default, but each relay can independently configure this).</p>
<h3 id="sending-data-to-the-upload-relay"><a class="header" href="#sending-data-to-the-upload-relay">Sending data to the upload relay</a></h3>
<p>See the full OpenAPI spec for the upload relay for the full details
(<a href="https://github.com/mystenlabs/walrus/tree/main/crates/walrus-upload-relay/upload_relay_openapi.yaml">yaml</a>,
<a href="https://github.com/mystenlabs/walrus/tree/main/crates/walrus-upload-relay/upload_relay_openapi.html">html</a>)</p>
<p>Essentially, the client sends a POST request to the <code>/v1/blob-upload-relay</code> API endpoint on the relay,
containing the bytes of the blob to be stored in the body.</p>
<p>These additional parameters have to be specified in the URL’s query string:</p>
<ul>
<li><strong>blob_id</strong> (required): The blob ID of the blob to be stored. Example:
<code>blob_id=E7_nNXvFU_3qZVu3OH1yycRG7LZlyn1-UxEDCDDqGGU</code></li>
<li><strong>tx_id</strong> (required if the relay requires tip): The transaction ID (Base58 encoded) of the
transaction that transferred the TIP to the relay. Example:
<code>tx_id=EmcFpdozbobqH61w76T4UehhC4UGaAv32uZpv6c4CNyg</code></li>
<li><strong>nonce</strong> (required if the relay requires tip): The <code>nonce</code>, the preimage of the hash added to the
transaction inputs created above, as a Base64 URL-encoded string without padding.
<code>nonce=rw8xIuqxwMpdOcF_3jOprsD9TtPWfXK97tT_lWr1teQ</code></li>
<li><strong>deletable_blob_object</strong> (required if the blob is registered as deletable): If the blob being
stored is deletable, then the client must specify the object ID (as a Hex string) of the Blob. If
the blob is to be stored as a permanent one, this parameter should not be specified. Example:
<code>deletable_blob_object=0x56ae1c86e17db174ea002f8340e28880bc8a8587c56e8604a4fa6b1170b23a60</code></li>
<li><strong>encoding_type</strong> (optional): The encoding type to be used for the blob. The default value, and at
the moment the only value, is <code>RS2</code>.</li>
</ul>
<h2 id="receiving-the-certificate"><a class="header" href="#receiving-the-certificate">Receiving the certificate</a></h2>
<p>Once the relay is done storing the blob, it will collect the confirmation certificate from the
storage nodes.</p>
<p>Then, it will send a response to the client, containing the <code>blob_id</code> of the stored blob, along with
the <code>confirmation_certificate</code>. The client can then use this certificate to certify the blob on
chain.</p>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<h3 id="download-the-binary"><a class="header" href="#download-the-binary">Download the binary</a></h3>
<p>If you'd like to download a pre-built binary in order manually run <code>walrus-upload-relay</code>, you'll
need to download it from <a href="https://github.com/MystenLabs/walrus/releases">the releases page</a>. Note
that <code>walrus-upload-relay</code> does not daemonize itself, and requires some supervisor process to ensure
boot at startup, to restart in the event of failures, etc.</p>
<h3 id="docker"><a class="header" href="#docker">Docker</a></h3>
<p>The docker image for <code>walrus-upload-relay</code> is available on Docker Hub as
<code>mysten/walrus-upload-relay</code>.</p>
<pre><code class="language-sh">docker run -it --rm mysten/walrus-upload-relay --help
</code></pre>
<h3 id="build-from-source"><a class="header" href="#build-from-source">Build from source</a></h3>
<p>Of course, if you'd like to build from sources, that is always an option, as well. The sources for
the <code>walrus-upload-relay</code> are available on <a href="https://github.com/MystenLabs/walrus">GitHub</a> in the
<code>crates/walrus-upload-relay</code> subdirectory. Running the following from the root of the Walrus repo
should get you a working binary.</p>
<pre><code class="language-sh">cargo build --release --bin walrus-upload-relay
./target/release/walrus-upload-relay --help
</code></pre>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>Notice that <code>walrus-upload-relay</code> requires some configuration to get started. Below is an example of
how you might place the configuration such that it is reachable when invoking Docker to run the
relay. For the sake of the example below, we're assuming that:</p>
<ul>
<li><code>$HOME/.config/walrus/walrus_upload_relay_config.yaml</code> exists on the host machine and contains the
configuration for the <code>walrus-upload-relay</code>, as described <a href="#relay-specific-configuration">in the configuration
section</a>.</li>
<li><code>$HOME/.config/walrus/client_config.yaml</code> exists on the host machine and contains Walrus client
configuration as specified <a href="../usage/setup.html#configuration">in the CLI setup section</a>.</li>
<li>Port 3000 is available for the relay to bind to (change this to whichever port you'd like to
expose from your host.)</li>
</ul>
<pre><code class="language-sh">docker run \
  -p 3000:3000 \
  -v $HOME/.config/walrus/walrus_upload_relay_config.yaml:/opt/walrus/walrus_upload_relay_config.yaml \
  -v $HOME/.config/walrus/client_config.yaml:/opt/walrus/client_config.yaml \
  mysten/walrus-upload-relay \
    --context testnet \
    --walrus-config /opt/walrus/client_config.yaml \
    --server-address 0.0.0.0:3000 \
    --relay-config /opt/walrus/walrus_upload_relay_config.yaml
</code></pre>
<h3 id="relay-specific-configuration"><a class="header" href="#relay-specific-configuration">Relay-specific configuration</a></h3>
<p>Here is an example of the <code>walrus-upload-relay</code> configuration file:</p>
<pre><code class="language-yaml">tip_config: !send_tip
  address: 0x2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a
  kind: !const 42
tx_freshness_threshold_secs: 36000
tx_max_future_threshold_secs: 30
</code></pre>
<p>Currently, the options are the following:</p>
<ul>
<li><code>tip_config</code>: The configuration for the tip to be paid. It can be <code>!no_tip</code>, for the free service,
or <code>!send_tip</code>, to configure the requested tip. In that case:
<ul>
<li><code>address</code>: Contains the hex-encoded address of the upload relay owner, where the tip should be
sent to.</li>
<li><code>kind</code>: The kind of tip that should be paid. It can be <code>!const</code>, for a constant tip for each
store, or <code>!linear</code>, for a linear tip in the unencoded blob size.</li>
</ul>
</li>
<li><code>tx_freshness_threshold_secs</code>: The maximum amount of time (in seconds) for which a transaction
that pays the tip is considered valid.</li>
<li><code>tx_max_future_threshold_secs</code>: The maximum amount of time in the future for which the tip-paying
transaction is considered valid. This is simply to account for some clock skew.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../operator-guide/backup-restore-guide.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../usage/stake.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../operator-guide/backup-restore-guide.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../usage/stake.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../docs/theme/tabs.js"></script>


    </div>
    </body>
</html>
