<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The authenticated publisher - Walrus</title>


        <!-- Custom HTML head -->
        <script type="text/javascript">
          // Hacky check to only load Amplitude in production since we don't have environments:
          const localAddresses = ['localhost', '127.0.0.1', '[::1]'];
          if (localAddresses.indexOf(document.location.hostname) === -1) {
            !function(){"use strict";!function(e,t){var r=e.amplitude||{_q:[],_iq:{}};if(r.invoked)e.console&&console.error&&console.error("Amplitude snippet has been loaded.");else{var n=function(e,t){e.prototype[t]=function(){return this._q.push({name:t,args:Array.prototype.slice.call(arguments,0)}),this}},s=function(e,t,r){return function(n){e._q.push({name:t,args:Array.prototype.slice.call(r,0),resolve:n})}},o=function(e,t,r){e._q.push({name:t,args:Array.prototype.slice.call(r,0)})},i=function(e,t,r){e[t]=function(){if(r)return{promise:new Promise(s(e,t,Array.prototype.slice.call(arguments)))};o(e,t,Array.prototype.slice.call(arguments))}},a=function(e){for(var t=0;t<g.length;t++)i(e,g[t],!1);for(var r=0;r<m.length;r++)i(e,m[r],!0)};r.invoked=!0;var c=t.createElement("script");c.type="text/javascript",c.integrity="sha384-pY2pkwHaLM/6UIseFHVU3hOKr6oAvhLcdYkoRZyaMDWLjpM6B7nTxtOdE823WAOQ",c.crossOrigin="anonymous",c.async=!0,c.src="https://cdn.amplitude.com/libs/analytics-browser-2.11.0-min.js.gz",c.onload=function(){e.amplitude.runQueuedFunctions||console.log("[Amplitude] Error: could not load SDK")};var u=t.getElementsByTagName("script")[0];u.parentNode.insertBefore(c,u);for(var p=function(){return this._q=[],this},l=["add","append","clearAll","prepend","set","setOnce","unset","preInsert","postInsert","remove","getUserProperties"],d=0;d<l.length;d++)n(p,l[d]);r.Identify=p;for(var f=function(){return this._q=[],this},v=["getEventProperties","setProductId","setQuantity","setPrice","setRevenue","setRevenueType","setEventProperties"],y=0;y<v.length;y++)n(f,v[y]);r.Revenue=f;var g=["getDeviceId","setDeviceId","getSessionId","setSessionId","getUserId","setUserId","setOptOut","setTransport","reset","extendSession"],m=["init","add","remove","track","logEvent","identify","groupIdentify","setGroup","revenue","flush"];a(r),r.createInstance=function(e){return r._iq[e]={_q:[]},a(r._iq[e]),r._iq[e]},e.amplitude=r}}(window,document)}();
            amplitude.init('f60df2d0d709d50faa2ffda153a84bc0', { identityStorage:'none', defaultTracking: true });
          }
        </script>
        
        <script>
            function initAskCookbook() {
              // It's a public API key, so it's safe to expose it here
              const PUBLIC_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2NzU4Y2YyODM4NTcxODU5MjU0MGIyMDciLCJpYXQiOjE3MzM4NzM0NDgsImV4cCI6MjA0OTQ0OTQ0OH0.Z3cv3HuMkYq3aYZYzCKkkYuM5LI3KG-kuA0R-GaSMV4";
        
              let cookbookContainer = document.getElementById("__cookbook");
              if (!cookbookContainer) {
                cookbookContainer = document.createElement("div");
                cookbookContainer.id = "__cookbook";
                cookbookContainer.dataset.apiKey = PUBLIC_API_KEY;
                document.body.appendChild(cookbookContainer);
              }
        
              let cookbookScript = document.getElementById("__cookbook-script");
              if (!cookbookScript) {
                cookbookScript = document.createElement("script");
                cookbookScript.id = "__cookbook-script";
                cookbookScript.src = "https://cdn.jsdelivr.net/npm/@cookbookdev/docsbot/dist/standalone/index.cjs.js";
                cookbookScript.async = true;
                document.head.appendChild(cookbookScript);
              }
        
        
              const keyPressPropagationBlocker = function (e) {
                e.stopPropagation();
              };
              document.addEventListener("cookbook:modal:state:change", function (e) {
                const isOpen = e.detail.isOpen;
                if (isOpen) {
                  document.body.addEventListener("keydown", keyPressPropagationBlocker, { capture: true });
                } else {
                  document.body.removeEventListener("keydown", keyPressPropagationBlocker, { capture: true });
                }
              });
            }
        
            // Check if the document is already loaded and if so, initialize the script, otherwise wait for the load event
            if (document.readyState === "complete") {
              initAskCookbook();
            } else {
              window.addEventListener("load", initAskCookbook);
            }
          </script>
        
          <meta name="algolia-site-verification" content="BCA21DA2879818D2">

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../docs/mdbook-admonish.css">
        <link rel="stylesheet" href="../docs/theme/tabs.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Walrus</a></li><li class="chapter-item expanded affix "><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Dev Blog</li><li class="chapter-item expanded "><a href="../blog/00_intro.html"><strong aria-hidden="true">1.</strong> Blog Preface</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../blog/01_announcing_walrus.html"><strong aria-hidden="true">1.1.</strong> Announcing Walrus</a></li><li class="chapter-item expanded "><a href="../blog/02_devnet_update.html"><strong aria-hidden="true">1.2.</strong> Devnet Update</a></li><li class="chapter-item expanded "><a href="../blog/03_whitepaper.html"><strong aria-hidden="true">1.3.</strong> Announcing the Walrus Whitepaper</a></li><li class="chapter-item expanded "><a href="../blog/04_testnet_update.html"><strong aria-hidden="true">1.4.</strong> Announcing Testnet</a></li><li class="chapter-item expanded "><a href="../blog/05_testnet_redeployment.html"><strong aria-hidden="true">1.5.</strong> Announcing Testnet v2</a></li><li class="chapter-item expanded "><a href="../blog/06_mainnet.html"><strong aria-hidden="true">1.6.</strong> Announcing Mainnet</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Usage</li><li class="chapter-item expanded "><a href="../usage/started.html"><strong aria-hidden="true">2.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="../usage/setup.html"><strong aria-hidden="true">3.</strong> Setup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../usage/networks.html"><strong aria-hidden="true">3.1.</strong> Available networks</a></li></ol></li><li class="chapter-item expanded "><a href="../usage/interacting.html"><strong aria-hidden="true">4.</strong> Interacting with Walrus</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../usage/client-cli.html"><strong aria-hidden="true">4.1.</strong> Using the client CLI</a></li><li class="chapter-item expanded "><a href="../usage/json-api.html"><strong aria-hidden="true">4.2.</strong> Using the client JSON API</a></li><li class="chapter-item expanded "><a href="../usage/web-api.html"><strong aria-hidden="true">4.3.</strong> Using the client HTTP API</a></li><li class="chapter-item expanded "><a href="../usage/sdks.html"><strong aria-hidden="true">4.4.</strong> SDKs and other tools</a></li></ol></li><li class="chapter-item expanded "><a href="../dev-guide/dev-guide.html"><strong aria-hidden="true">5.</strong> Developer guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dev-guide/components.html"><strong aria-hidden="true">5.1.</strong> Components</a></li><li class="chapter-item expanded "><a href="../dev-guide/dev-operations.html"><strong aria-hidden="true">5.2.</strong> Operations</a></li><li class="chapter-item expanded "><a href="../dev-guide/costs.html"><strong aria-hidden="true">5.3.</strong> Storage costs</a></li><li class="chapter-item expanded "><a href="../dev-guide/sui-struct.html"><strong aria-hidden="true">5.4.</strong> Sui structures</a></li><li class="chapter-item expanded "><a href="../dev-guide/data-security.html"><strong aria-hidden="true">5.5.</strong> Data security</a></li><li class="chapter-item expanded "><a href="../usage/quilt.html"><strong aria-hidden="true">5.6.</strong> Quilt</a></li></ol></li><li class="chapter-item expanded "><a href="../operator-guide/operator-guide.html"><strong aria-hidden="true">6.</strong> Operator guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../operator-guide/aggregator.html"><strong aria-hidden="true">6.1.</strong> Operating an aggregator or publisher</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../operator-guide/auth-publisher.html" class="active"><strong aria-hidden="true">6.1.1.</strong> The authenticated publisher</a></li></ol></li><li class="chapter-item expanded "><a href="../operator-guide/storage-node.html"><strong aria-hidden="true">6.2.</strong> Operating a storage node</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../operator-guide/commission-governance.html"><strong aria-hidden="true">6.2.1.</strong> Commission and governance</a></li><li class="chapter-item expanded "><a href="../operator-guide/backup-restore-guide.html"><strong aria-hidden="true">6.2.2.</strong> Backup and restore</a></li></ol></li><li class="chapter-item expanded "><a href="../operator-guide/upload-relay.html"><strong aria-hidden="true">6.3.</strong> Upload relay: functioning and operation</a></li></ol></li><li class="chapter-item expanded "><a href="../usage/stake.html"><strong aria-hidden="true">7.</strong> Staking and unstaking</a></li><li class="chapter-item expanded "><a href="../usage/examples.html"><strong aria-hidden="true">8.</strong> Examples</a></li><li class="chapter-item expanded "><a href="../usage/troubleshooting.html"><strong aria-hidden="true">9.</strong> Troubleshooting</a></li><li class="chapter-item expanded affix "><li class="part-title">Sites</li><li class="chapter-item expanded "><a href="../walrus-sites/intro.html"><strong aria-hidden="true">10.</strong> Introduction to Walrus Sites</a></li><li class="chapter-item expanded "><a href="../walrus-sites/tutorial.html"><strong aria-hidden="true">11.</strong> Your first Walrus Site</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../walrus-sites/tutorial-install.html"><strong aria-hidden="true">11.1.</strong> Installing the site builder</a></li><li class="chapter-item expanded "><a href="../walrus-sites/tutorial-publish.html"><strong aria-hidden="true">11.2.</strong> Publishing a Walrus Site</a></li><li class="chapter-item expanded "><a href="../walrus-sites/tutorial-suins.html"><strong aria-hidden="true">11.3.</strong> Set a SuiNS name</a></li></ol></li><li class="chapter-item expanded "><a href="../walrus-sites/advanced.html"><strong aria-hidden="true">12.</strong> Advanced functionality</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../walrus-sites/commands.html"><strong aria-hidden="true">12.1.</strong> Site builder commands</a></li><li class="chapter-item expanded "><a href="../walrus-sites/builder-config.html"><strong aria-hidden="true">12.2.</strong> Advanced site-builder configuration</a></li><li class="chapter-item expanded "><a href="../walrus-sites/routing.html"><strong aria-hidden="true">12.3.</strong> Specifying headers, routing, and metadata</a></li><li class="chapter-item expanded "><a href="../walrus-sites/linking.html"><strong aria-hidden="true">12.4.</strong> Linking from and to Walrus Sites</a></li><li class="chapter-item expanded "><a href="../walrus-sites/redirects.html"><strong aria-hidden="true">12.5.</strong> Redirecting objects to Walrus Sites</a></li><li class="chapter-item expanded "><a href="../walrus-sites/ci-cd.html"><strong aria-hidden="true">12.6.</strong> CI/CD</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../walrus-sites/ci-cd-gh-secrets-vars.html"><strong aria-hidden="true">12.6.1.</strong> Setting up GitHub secrets and vars</a></li><li class="chapter-item expanded "><a href="../walrus-sites/ci-cd-gh-workflow.html"><strong aria-hidden="true">12.6.2.</strong> Creating GitHub workflow</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../walrus-sites/overview.html"><strong aria-hidden="true">13.</strong> Technical overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../walrus-sites/portal.html"><strong aria-hidden="true">13.1.</strong> The Walrus Sites portal</a></li><li class="chapter-item expanded "><a href="../walrus-sites/bring-your-own-domain.html"><strong aria-hidden="true">13.2.</strong> Bring your own domain</a></li><li class="chapter-item expanded "><a href="../walrus-sites/authentication.html"><strong aria-hidden="true">13.3.</strong> Site data authentication</a></li><li class="chapter-item expanded "><a href="../walrus-sites/restrictions.html"><strong aria-hidden="true">13.4.</strong> Known restrictions</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Design</li><li class="chapter-item expanded "><a href="../design/objectives_use_cases.html"><strong aria-hidden="true">14.</strong> Objectives and use cases</a></li><li class="chapter-item expanded "><a href="../design/overview.html"><strong aria-hidden="true">15.</strong> Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../design/architecture.html"><strong aria-hidden="true">15.1.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../design/encoding.html"><strong aria-hidden="true">15.2.</strong> Encoding</a></li></ol></li><li class="chapter-item expanded "><a href="../design/operations.html"><strong aria-hidden="true">16.</strong> Operations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../design/operations-sui.html"><strong aria-hidden="true">16.1.</strong> Sui operations</a></li><li class="chapter-item expanded "><a href="../design/operations-off-chain.html"><strong aria-hidden="true">16.2.</strong> Off-chain operations</a></li></ol></li><li class="chapter-item expanded "><a href="../design/properties.html"><strong aria-hidden="true">17.</strong> Properties</a></li><li class="chapter-item expanded "><a href="../design/future.html"><strong aria-hidden="true">18.</strong> Future discussion</a></li><li class="chapter-item expanded affix "><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../glossary.html">Glossary</a></li><li class="chapter-item expanded affix "><a href="../legal/testnet_tos.html">Testnet terms of service</a></li><li class="chapter-item expanded affix "><a href="../legal/privacy.html">Privacy policy</a></li><li class="chapter-item expanded affix "><a href="../legal/walrus_general_tos.html">Walrus general terms of service</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Walrus</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="the-authenticated-publisher"><a class="header" href="#the-authenticated-publisher">The authenticated publisher</a></h1>
<p>We now describe the authenticated publisher, which requires the HTTP request to store a blob to be
authenticated. Such an authenticated publisher can be used as a building block for services that
require storing over HTTP on Walrus <code>mainnet</code>, where an "open" publisher is undesirable (because of
the <code>SUI</code> and <code>WAL</code> cost of publishing to Walrus).</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>The Walrus Publisher can be configured to require a JWT (JSON web Token) with each HTTP request, for
user authentication. The authentication system ensures that only authorized clients can store blobs
and allows for fine-grained control over storage parameters through JWT claims.</p>
<p>The authenticated publishing flow occurs, at a high level, as follows:</p>
<ol>
<li><strong>Publisher setup</strong>: The publisher operator:
<ul>
<li>Funds the publisher's wallet with sufficient <code>SUI</code> and <code>WAL</code>;</li>
<li>Configures the publisher to only accept authenticated requests. This entails setting the
algorithm to authenticate JWTs, the expiration time for JWTs, and the JWT authentication
secret.</li>
</ul>
</li>
<li><strong>Authentication channel setup</strong>: The publisher operator sets up a channel through which users
can obtain the JWT tokens. This step can be performed in any way that produces a valid JWT, and
is not provided in this implementation.</li>
<li><strong>Client authentication</strong>: The client obtains a JWT token from the channel set up in the previous
step. The JWT token can specify Walrus-relevant constraints, such as the maximum number of epochs
the JWT can be used to store for, and the maximum size of the blobs being stored.</li>
<li><strong>Publish request</strong>: The client requests to store a blob using the publisher. This is done
through an HTTP PUT request containing the JWT in an Authorization Bearer HTTP header.</li>
<li><strong>Store to Walrus</strong>: The publisher checks the JWT, and checks that the store request is compliant
with the constraints specified in the JWT (e.g., the blob being stored is smaller than the
authorized max size).</li>
<li>(Optional) <strong>Asset return:</strong>: If so specified, the publisher returns the newly-created <code>Blob</code>
object to the Sui Address set in the request.</li>
</ol>
<h3 id="request-authentication-flow"><a class="header" href="#request-authentication-flow">Request authentication flow</a></h3>
<p>We now provide an example of how the authenticated publisher can be used in a webapp that allows
users to upload files to Walrus through a web frontend. This is especially useful if the users are
<em>not</em> required to have a wallet, and therefore cannot store blobs to Walrus on their own.</p>
<ul>
<li>The user connects to the webapp, authenticates (e.g., through name and password, as they have no
wallet).</li>
<li>The user uploads the file it wants to store, and selects the number of epochs for which it would
like to store it.</li>
<li>The webapp frontend sends information on the size of the file and the number of epochs to the
backend.</li>
<li>With this information, the backend computes if the user is authorized to store the given amount of
data for the selected number of epochs, and possibly reduces the user quota. This accounting can
be done locally, but also directly on Sui. Importantly, at this point the backend can also check
the cost of the upload (in terms of SUI and WAL), and check if it is within the user's budget.</li>
<li>If the user is authorized to store, the backend returns a JWT token with the size and epoch limits
to the frontend.</li>
<li>The frontend sends the file to the publisher via a <code>PUT</code> request, setting the JWT in the
Authorization header as a Bearer token.</li>
<li>Upon receipt, the publisher verifies:
<ul>
<li>The token signature using the configured secret;</li>
<li>Token expiration;</li>
<li>Token uniqueness (prevents replay attacks);</li>
<li>Upload parameters against claims (if enabled).</li>
</ul>
</li>
<li>If all checks succeed, the publisher stores the file on Walrus.</li>
<li>If set, the publisher finally returns the created <code>Blob</code> object to the address specified by the
user.</li>
</ul>
<p>One important note here is that the JWT token itself is a "single use" token, and should not be used
for accounting purposes. I.e., one token can be used to store only one file, and after that the
token is rejected by the replay suppression system.</p>
<h2 id="publisher-setup"><a class="header" href="#publisher-setup">Publisher setup</a></h2>
<p>The publisher is configured at startup using the following command line arguments:</p>
<ul>
<li><code>--jwt-decode-secret</code>: The secret key used to verify JWT signatures. If set, the publisher will
only store blobs with valid JWTs.</li>
<li><code>--jwt-algorithm</code>: The algorithm used for JWT verification (defaults to HMAC).</li>
<li><code>--jwt-expiring-sec</code>: Duration in seconds after which the JWT is considered expired.</li>
<li><code>--jwt-verify-upload</code>: Enable verification of upload parameters against JWT claims.</li>
</ul>
<p>Additional details follow.</p>
<h3 id="the-jwt-decode-secret"><a class="header" href="#the-jwt-decode-secret">The JWT decode secret</a></h3>
<p>The secret can be hex string, starting with <code>0x</code>. If this parameter is not specified, the
authentication will be disabled.</p>
<p>All JWT tokens are expected to have the <code>jti</code> (JWT ID) set in the claim to a unique value. The JWT
is used for replay suppression, i.e., to avoid malicious users storing multiple times using the same
JWT. Therefore, the JWT creator must ensure that this value is unique among all requests to the
publisher. We recommend using large nonces to avoid collisions.</p>
<h3 id="authentication-algorithm"><a class="header" href="#authentication-algorithm">Authentication algorithm</a></h3>
<p>The following algorithms are supported: "HS256", "HS384", "HS512", "ES256", "ES384", "RS256",
"RS384", "PS256", "PS384", "PS512", "RS512", "EdDSA". The default JWT authentication algorithm will
be HS256.</p>
<h3 id="jwt-expiration"><a class="header" href="#jwt-expiration">JWT Expiration</a></h3>
<p>If the parameter is set and greater than 0, the publisher will check if the JWT token is expired
based on the "issued at" (<code>iat</code>) value in the JWT token.</p>
<h3 id="upload-parameters-verification"><a class="header" href="#upload-parameters-verification">Upload parameters verification</a></h3>
<p>If set, the publisher will verify that the requested upload matches the claims in the JWT. This
<em>does not</em> enable or disable the cryptographic authentication of the JWT; it just enables or
disables the checks that ensure the contents of the JWT claim match the requested blob upload.</p>
<p>Specifically, the publisher will:</p>
<ul>
<li>Verify that the number of <code>epochs</code> in query is the the same as <code>epochs</code> in the JWT, if present;</li>
<li>Verify that the <code>send_object_to</code> field in the query is the same as the <code>send_object_to</code> in the
JWT, if present;</li>
<li>Verify the size of uploaded file;</li>
<li>Verify the uniqueness of the <code>jti</code> claim.</li>
</ul>
<p>Disabiling the parameter verification may be useful in case the source of the store requests is
trusted, but the publisher mayy be contacted by untrusted sources. In that case, the authentication
of the JWT is necessary, but not the verification of the upload parameters.</p>
<h3 id="replay-suppression-configuration"><a class="header" href="#replay-suppression-configuration">Replay-suppression configuration</a></h3>
<p>As mentioned above, the publisher supports replay suppression to avoid the malicious reuse of JWT
tokens.</p>
<p>The replay suppression supports the following configuration parameters:</p>
<ul>
<li><code>--jwt-cache-size</code>: The maximum size of the publisher's JWT cache, where the <code>jti</code> JWT IDs of the
"used" JWTs are kept until their expiration. This is a hard upperbound on the number of entries in
the cache, after which additional requests to store are rejected. This hard bound is introduced to
avoid DoS attacks on the publisher through the cache.</li>
<li><code>--jwt-cache-refresh-interval</code>: The interval (in seconds) after which the cache is refreshed, and
expired JWTs are removed (possibly creating space for additional JWTs to be inserted).</li>
</ul>
<h2 id="details-on-the-jwt"><a class="header" href="#details-on-the-jwt">Details on the JWT</a></h2>
<h3 id="jwt-fields"><a class="header" href="#jwt-fields">JWT Fields</a></h3>
<p>The current authenticated publisher implementation does not provide a way to generate the JWTs and
distribute them to the clients. These can be generated with any tool (examples on how to create a
JWT are given in the next section), as long as they respect the following constraints.</p>
<h4 id="mandatory-fields"><a class="header" href="#mandatory-fields">Mandatory fields</a></h4>
<ul>
<li><code>exp</code> (Expiration): timestamp when the token expires;</li>
<li><code>jti</code> (JWT ID): unique identifier for the token to prevent replay attacks;</li>
</ul>
<h4 id="optional-fields"><a class="header" href="#optional-fields">Optional fields</a></h4>
<ul>
<li><code>iat</code> (Issued At): Optional timestamp when the token was issued;</li>
<li><code>send_object_to</code>: Optional Sui address where the newly-created <code>Blob</code> object should be sent;</li>
<li><code>epochs</code>: Optional exact number of epochs the blob should be stored for</li>
<li><code>max_epochs</code>: Optional maximum number of epochs the blob can be stored for</li>
<li><code>max_size</code>: Optional maximum size of the blob in bytes</li>
<li><code>size</code>: Optional exact size of the blob in bytes</li>
</ul>
<p>Note: The <code>epochs</code> and <code>max_epochs</code> claims cannot be used together, and neither can <code>size</code> and
<code>max_size</code>. Using both in either case will result in token rejection.</p>
<p>Importanlty, the JWT (at the moment) can only encode information on the size and epochs of the blob
to store, and not on the "amount of SUI and WAL" the user is allowed to consume. This should be done
on the backend, before issuing the JWT.</p>
<h3 id="creating-a-valid-jwt-in-the-backend"><a class="header" href="#creating-a-valid-jwt-in-the-backend">Creating a valid JWT in the backend[</a></h3>
<p>We provide here a few examples on how to create JWTs that can be consumed by the authenticated
publisher.</p>
<h4 id="rust"><a class="header" href="#rust">Rust</a></h4>
<p>In Rust, the <a href="https://docs.rs/jsonwebtoken/latest/jsonwebtoken/"><code>jsonwebtoken</code></a> crate can be
used to create JWTs.</p>
<p>In our code, we use the following struct to deserialize the incoming tokens in the publisher (see
the the
<a href="https://github.com/MystenLabs/walrus/blob/main/crates/walrus-service/src/client/daemon/auth.rs">code</a>
for the complete version).</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Claim {
    pub iat: Option&lt;i64&gt;,
    pub exp: i64,
    pub jti: String,
    pub send_object_to: Option&lt;SuiAddress&gt;,
    pub epochs: Option&lt;u32&gt;,
    pub max_epochs: Option&lt;u32&gt;,
    pub size: Option&lt;u64&gt;,
    pub max_size: Option&lt;u64&gt;,
}
<span class="boring">}</span></code></pre></pre>
<p>The same struct can be used to create and then encode valid tokens in Rust. This will be something
along the lines of:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use jsonwebtoken::{encode, Algorithm, EncodingKey, Header};

...

let encoding_key = EncodingKey::from_secret("my_secret".as_bytes());
let claim = Claim { /* set here the parameters for the Claim struct above */ };
let jwt = encode(&amp;Header::default(), &amp;claim, &amp;encode_key).expect("a valid claim and key");
<span class="boring">}</span></code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../operator-guide/aggregator.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../operator-guide/storage-node.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../operator-guide/aggregator.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../operator-guide/storage-node.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../docs/theme/tabs.js"></script>


    </div>
    </body>
</html>
